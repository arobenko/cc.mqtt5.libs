#include "UnitTestDefs.h"
#include "UnitTestPropsHandler.h"
#include "UnitTestProtocolDefs.h"

#include "client.h"

#include <cxxtest/TestSuite.h>

class UnitTestClient : public CxxTest::TestSuite
{
public:
    void test1();
    void test2();

private:
    void setUp()
    {
        m_tickReqs.clear();
    }

    static void brokerDisconnectedCb([[maybe_unused]] void* obj, [[maybe_unused]] const CC_Mqtt5DisconnectInfo* info)
    {
    }

    static void messageReceivedCb([[maybe_unused]] void* obj, [[maybe_unused]] const CC_Mqtt5MessageInfo* info)
    {
    }

    static void sendOutputDataCb([[maybe_unused]] void* obj, [[maybe_unused]] const unsigned char* buf, [[maybe_unused]] unsigned bufLen)
    {
    }

    static void programNextTickCb(void* obj, unsigned duration)
    {
        auto* realObj = reinterpret_cast<UnitTestClient*>(obj);
        TS_ASSERT(realObj->m_tickReqs.empty());
        realObj->m_tickReqs.push_back(duration);
    }

    static unsigned cancelNextTickWaitCb(void* obj) {
        static_cast<void>(obj);
        TS_ASSERT(false);
        return 0U;
    }

    std::vector<unsigned> m_tickReqs;

};

void UnitTestClient::test1()
{
    UnitTestClientPtr client(cc_mqtt5_client_alloc());
    TS_ASSERT(client);

    auto ec = cc_mqtt5_client_init(client.get());
    TS_ASSERT_EQUALS(ec, CC_Mqtt5ErrorCode_BadParam);

    cc_mqtt5_client_set_broker_disconnect_report_callback(client.get(), &UnitTestClient::brokerDisconnectedCb, this);
    ec = cc_mqtt5_client_init(client.get());
    TS_ASSERT_EQUALS(ec, CC_Mqtt5ErrorCode_BadParam);

    cc_mqtt5_client_set_send_output_data_callback(client.get(), &UnitTestClient::sendOutputDataCb, this);
    ec = cc_mqtt5_client_init(client.get());
    TS_ASSERT_EQUALS(ec, CC_Mqtt5ErrorCode_BadParam);

    cc_mqtt5_client_set_message_received_report_callback(client.get(), &UnitTestClient::messageReceivedCb, this);
    ec = cc_mqtt5_client_init(client.get());
    TS_ASSERT_EQUALS(ec, CC_Mqtt5ErrorCode_Success);    
}

void UnitTestClient::test2()
{
    UnitTestClientPtr client(cc_mqtt5_client_alloc());
    TS_ASSERT(client);

    cc_mqtt5_client_set_broker_disconnect_report_callback(client.get(), &UnitTestClient::brokerDisconnectedCb, this);
    cc_mqtt5_client_set_message_received_report_callback(client.get(), &UnitTestClient::messageReceivedCb, this);
    cc_mqtt5_client_set_send_output_data_callback(client.get(), &UnitTestClient::sendOutputDataCb, this);
    cc_mqtt5_client_set_next_tick_program_callback(client.get(), &UnitTestClient::programNextTickCb, this);

    auto ec = cc_mqtt5_client_init(client.get());
    TS_ASSERT_EQUALS(ec, CC_Mqtt5ErrorCode_BadParam);    

    cc_mqtt5_client_set_cancel_next_tick_wait_callback(client.get(), &UnitTestClient::cancelNextTickWaitCb, this);
    ec = cc_mqtt5_client_init(client.get());
    TS_ASSERT_EQUALS(ec, CC_Mqtt5ErrorCode_Success);    

}
